{% extends "base.html" %}
{% block content %}
<h2>Edit Poem</h2>
<form method="post">
  <!-- Row for Title and Type fields -->
  <div class="row mb-3">
    <div class="col">
      <label for="title" class="form-label">Title</label>
      <input type="text" class="form-control" id="title" name="title" value="{{ poem.title }}" required>
    </div>
    <div class="col">
      <label for="type" class="form-label">Type</label>
      <input type="text" class="form-control" id="type" name="type" value="{{ poem.type if poem.type else '' }}" placeholder="e.g., Free verse, Ode, Hermit Crab">
    </div>
  </div>
  <div class="mb-3">
    <label for="content" class="form-label">Content</label>
    <textarea class="form-control" id="content" name="content" rows="20" required>{{ poem.content }}</textarea>
  </div>
  <!-- Tag Input Field -->
<div class="mb-3" style="position: relative;">
  <label for="tag-input" class="form-label">Tags</label>
  <input type="text" class="form-control" id="tag-input" placeholder="Type a tag and press Enter" autocomplete="off">
  <div id="tag-suggestions" class="autocomplete-suggestions" style="display: none;"></div>
  <div id="tag-chips" class="tag-chips-container"></div>
  <input type="hidden" name="tags" id="tags-hidden">
</div>

  <!-- Visibility Dropdown for Poem -->
  <div class="mb-3">
    <label for="visibility" class="form-label">Visibility</label>
    <select class="form-select" id="visibility" name="visibility">
      <option value="public" {% if poem.visibility == 'public' %}selected{% endif %}>Public</option>
      <option value="private" {% if poem.visibility == 'private' %}selected{% endif %}>Private</option>
    </select>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-primary prf-add">Update</button>
    <button type="button" class="btn btn-secondary discard-button discard-custom" id="discardBtn">Discard</button>
  </div>
</form>

<!-- Discard Confirmation Modal -->
<div class="modal fade" id="discardConfirmModal" tabindex="-1" aria-labelledby="discardConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="discardConfirmModalLabel">Discard Changes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Do you want to discard your changes?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-danger" id="confirmDiscardBtn">Yes</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  let initialTags = {{ poem.tags | map(attribute='name') | list | tojson | safe }};

  // Tag functionality for edit_poem.html
  (function() {
    const tagInput = document.getElementById('tag-input');
    const tagChipsContainer = document.getElementById('tag-chips');
    const tagSuggestions = document.getElementById('tag-suggestions');
    const tagsHidden = document.getElementById('tags-hidden');
    let tags = [];

    // Prepopulate initial tags passed from the backend
    initialTags.forEach(function(tag) {
      addTag(tag);
    });

    function updateHiddenInput() {
      tagsHidden.value = tags.join(',');
    }

    function createTagChip(tag) {
      const chip = document.createElement('span');
      chip.className = 'tag-chip';
      chip.textContent = tag;

      const removeBtn = document.createElement('span');
      removeBtn.className = 'remove-tag';
      removeBtn.textContent = 'x';
      removeBtn.onclick = function() {
        tagChipsContainer.removeChild(chip);
        tags = tags.filter(t => t !== tag);
        updateHiddenInput();
      };

      chip.appendChild(removeBtn);
      return chip;
    }

    function addTag(tag) {
      if (tag && !tags.includes(tag)) {
        tags.push(tag);
        const chip = createTagChip(tag);
        tagChipsContainer.appendChild(chip);
        updateHiddenInput();
      }
    }

    tagInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const tag = tagInput.value.trim();
        if (tag !== '') {
          addTag(tag);
          tagInput.value = '';
          tagSuggestions.style.display = 'none';
        }
      }
    });

    tagInput.addEventListener('input', function() {
      const query = tagInput.value.trim();
      if (query.length > 0) {
        fetch(`/autocomplete_tags?query=${query}`)
          .then(response => response.json())
          .then(data => {
            tagSuggestions.innerHTML = '';
            if (data.length > 0) {
              data.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = suggestion;
                div.addEventListener('click', function() {
                  addTag(suggestion);
                  tagInput.value = '';
                  tagSuggestions.style.display = 'none';
                });
                tagSuggestions.appendChild(div);
              });
              tagSuggestions.style.display = 'block';
            } else {
              const div = document.createElement('div');
              div.className = 'autocomplete-suggestion';
              div.textContent = `Add "${query}"`;
              div.addEventListener('click', function() {
                addTag(query);
                tagInput.value = '';
                tagSuggestions.style.display = 'none';
              });
              tagSuggestions.appendChild(div);
              tagSuggestions.style.display = 'block';
            }
          });
      } else {
        tagSuggestions.style.display = 'none';
      }
    });

    document.addEventListener('click', function(e) {
      if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
        tagSuggestions.style.display = 'none';
      }
    });
  })();
  // When Discard is clicked, show the confirmation modal
  document.getElementById('discardBtn').addEventListener('click', function() {
    var discardModal = new bootstrap.Modal(document.getElementById('discardConfirmModal'));
    discardModal.show();
  });

  // If user confirms discard, redirect to the profile page
  document.getElementById('confirmDiscardBtn').addEventListener('click', function() {
    window.location.href = "{{ url_for('profile') }}";
  });
</script>
{% endblock %}
